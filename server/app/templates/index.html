<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JSON Editor UI</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
</head>
<body>
  <h1>JSON Data Viewer & Editor</h1>
  <form id="jsonForm"></form>
  <button onclick="submitJson()">Save Changes</button>

  <h3>Raw JSON (Preview)</h3>
  <pre id="jsonPreview"></pre>

  <script>
    let originalJson = {};

    async function loadJson() {
      const res = await fetch('/json/data');
      const data = await res.json();
      originalJson = data;
      const form = document.getElementById('jsonForm');
      form.innerHTML = '';
      renderJsonRecursive(data, '', form, 2);
      renderPreview(data);
    }

    function renderJsonRecursive(obj, path, container, level = 2) {
      for (const key in obj) {
        const value = obj[key];
        const fullPath = path ? (Array.isArray(obj) ? `${path}[${key}]` : `${path}.${key}`) : key;

        const section = document.createElement('div');
        section.className = 'json-section';

        if (typeof value === 'object' && value !== null) {
          const header = document.createElement(`h${Math.min(level, 5)}`);
          header.textContent = capitalize(key);
          section.appendChild(header);
          renderJsonRecursive(value, fullPath, section, level + 1);
        } else {
          const group = document.createElement('div');
          group.className = 'json-entry';

          const label = document.createElement('label');
          label.textContent = `${key}:`;

          const input = document.createElement('input');
          input.type = 'text';
          input.name = fullPath;
          input.value = value;

          group.appendChild(label);
          group.appendChild(input);
          section.appendChild(group);
        }

        container.appendChild(section);
      }
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    async function submitJson() {
      const form = document.getElementById('jsonForm');
      const formData = new FormData(form);
      const flatData = {};

      for (const [path, val] of formData.entries()) {
        flatData[path] = parseValue(val);
      }

      const newJson = unflattenJson(flatData);

      const res = await fetch('/json/data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newJson)
      });

      const result = await res.json();
      alert(result.message || result.error);
      renderPreview(newJson);
    }

    function parseValue(val) {
      if (val === 'true') return true;
      if (val === 'false') return false;
      if (!isNaN(val)) return Number(val);
      return val;
    }

    function unflattenJson(flat) {
      const result = {};
      for (const flatKey in flat) {
        const value = flat[flatKey];
        const keys = flatKey
          .replace(/\]/g, '')
          .split(/[\.\[]/g);

        let current = result;
        keys.forEach((k, i) => {
          const isLast = i === keys.length - 1;
          const isIndex = /^\d+$/.test(k);

          if (isLast) {
            if (isIndex) {
              if (!Array.isArray(current)) current = [];
              current[k] = value;
            } else {
              current[k] = value;
            }
          } else {
            if (!current[k]) {
              current[k] = /^\d+$/.test(keys[i + 1]) ? [] : {};
            }
            current = current[k];
          }
        });
      }
      return result;
    }

    function renderPreview(data) {
      document.getElementById('jsonPreview').textContent = JSON.stringify(data, null, 2);
    }

    loadJson();
  </script>
</body>
</html>
